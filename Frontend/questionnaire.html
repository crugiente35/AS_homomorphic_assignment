<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cuestionario Cifrado - FHE</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 40px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            text-align: center;
        }

        .subtitle {
            color: #666;
            text-align: center;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .info-box {
            background: #f0f4ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 30px;
            border-radius: 4px;
        }

        .info-box h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .info-box p {
            color: #555;
            font-size: 14px;
            line-height: 1.6;
        }

        .question {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .question h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .option {
            display: flex;
            align-items: center;
            padding: 12px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .option input[type="radio"] {
            margin-right: 10px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .option label {
            cursor: pointer;
            flex: 1;
            font-size: 16px;
            color: #333;
        }

        .option input[type="radio"]:checked + label {
            color: #667eea;
            font-weight: 600;
        }

        .button-container {
            display: flex;
            justify-content: center;
            margin-top: 30px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }

        .status {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            border-radius: 6px;
            font-weight: 500;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .deadline {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px;
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 6px;
            color: #856404;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1 style="margin: 0;">üìä Cuestionario Cifrado</h1>
            <a id="results-link" href="#" style="display: none; background: #667eea; color: white; padding: 10px 20px; border-radius: 6px; text-decoration: none; font-weight: 600;">
                Ver Resultados üìä
            </a>
        </div>
        <p class="subtitle">Tus respuestas est√°n protegidas con cifrado homom√≥rfico</p>
        
        <div class="info-box">
            <h3>üîí Privacidad Garantizada</h3>
            <p>Este cuestionario utiliza cifrado homom√≥rfico (BFV), lo que significa que tus respuestas se cifran en tu navegador antes de enviarse. El servidor nunca ve tus respuestas en texto plano, solo puede sumarlas de forma cifrada.</p>
        </div>

        <div id="deadline-container"></div>
        
        <div id="questionnaire-container">
            <!-- Las preguntas se cargar√°n din√°micamente -->
        </div>

        <div class="button-container">
            <button id="submit-btn" onclick="submitQuestionnaire()">
                Enviar Respuestas Cifradas üîê
            </button>
        </div>

        <div id="status-message"></div>
    </div>

    <!-- Import all JavaScript modules -->
    <script src="polynomial.js"></script>
    <script src="number_theory.js"></script>
    <script src="ntt.js"></script>
    <script src="random_sample.js"></script>
    <script src="crypto_structures.js"></script>
    <script src="batch_encoder.js"></script>
    <script src="bfv_encryptor.js"></script>

    <script>
        // Global variables
        let questionnaireData = null;
        let publicKey = null;
        let params = null;
        let encoder = null;
        let encryptor = null;

        // Get questionnaire ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const questionnaireId = urlParams.get('id') || 'default';

        // Load questionnaire on page load
        window.addEventListener('DOMContentLoaded', loadQuestionnaire);

        async function loadQuestionnaire() {
            try {
                showStatus('Cargando cuestionario...', 'info');
                
                // Fetch questionnaire data from backend
                const response = await fetch(`/api/questionnaire/${questionnaireId}`);
                
                if (!response.ok) {
                    throw new Error('No se pudo cargar el cuestionario');
                }
                
                const data = await response.json();
                questionnaireData = data;
                
                // Setup crypto parameters
                params = {
                    polyDegree: data.params.poly_degree,
                    plainModulus: data.params.plain_modulus,
                    ciphModulus: data.params.ciph_modulus,
                    scalingFactor: data.params.ciph_modulus / data.params.plain_modulus
                };
                
                // Deserialize public key
                publicKey = PublicKey.fromJSON(data.public_key);
                
                // Initialize encoder and encryptor
                encoder = new BatchEncoder(params);
                encryptor = new BFVEncryptor(params, publicKey);
                
                // Display deadline
                displayDeadline(data.deadline);
                
                // Render questions
                renderQuestions(data.questions);
                
                // Show results link if questionnaire has responses
                checkAndShowResultsLink();
                
                showStatus('Cuestionario cargado correctamente', 'success');
                setTimeout(() => clearStatus(), 2000);
                
            } catch (error) {
                console.error('Error loading questionnaire:', error);
                showStatus('Error al cargar el cuestionario: ' + error.message, 'error');
            }
        }

        async function checkAndShowResultsLink() {
            try {
                const response = await fetch(`/api/questionnaire/${questionnaireId}/stats`);
                if (response.ok) {
                    const stats = await response.json();
                    // Only show results link if questionnaire has responses AND is expired
                    if (stats.num_responses > 0 && stats.is_expired) {
                        const resultsLink = document.getElementById('results-link');
                        resultsLink.href = `results.html?id=${questionnaireId}`;
                        resultsLink.style.display = 'block';
                    }
                }
            } catch (error) {
                console.log('Could not check stats:', error);
            }
        }

        function displayDeadline(deadline) {
            const container = document.getElementById('deadline-container');
            const deadlineDate = new Date(deadline);
            const now = new Date();
            
            if (deadlineDate > now) {
                const daysLeft = Math.ceil((deadlineDate - now) / (1000 * 60 * 60 * 24));
                container.innerHTML = `
                    <div class="deadline">
                        ‚è∞ Fecha l√≠mite: ${deadlineDate.toLocaleDateString('es-ES')} 
                        (quedan ${daysLeft} d√≠a${daysLeft !== 1 ? 's' : ''})
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="deadline" style="background: #f8d7da; border-color: #f5c6cb; color: #721c24;">
                        ‚ö†Ô∏è Este cuestionario ha expirado
                    </div>
                `;
                document.getElementById('submit-btn').disabled = true;
            }
        }

        function renderQuestions(questions) {
            const container = document.getElementById('questionnaire-container');
            container.innerHTML = '';
            
            questions.forEach((question, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question';
                questionDiv.innerHTML = `
                    <h3>Pregunta ${index + 1}: ${question.text}</h3>
                    <div class="options">
                        ${question.options.map((option, optIndex) => {
                            // Skip options that are "N/A"
                            if (option.trim().toUpperCase() === 'N/A') {
                                return '';
                            }
                            return `
                                <div class="option">
                                    <input type="radio" 
                                           id="q${index}_opt${optIndex}" 
                                           name="question${index}" 
                                           value="${optIndex}">
                                    <label for="q${index}_opt${optIndex}">${option}</label>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                container.appendChild(questionDiv);
            });
        }

        async function submitQuestionnaire() {
            try {
                // Check if deadline has passed
                if (new Date(questionnaireData.deadline) < new Date()) {
                    showStatus('El cuestionario ha expirado', 'error');
                    return;
                }
                
                // Collect answers
                const answers = [];
                for (let i = 0; i < questionnaireData.questions.length; i++) {
                    const selected = document.querySelector(`input[name="question${i}"]:checked`);
                    if (!selected) {
                        showStatus(`Por favor responde la pregunta ${i + 1}`, 'error');
                        return;
                    }
                    answers.push(parseInt(selected.value));
                }
                
                // Disable submit button
                const submitBtn = document.getElementById('submit-btn');
                submitBtn.disabled = true;
                submitBtn.innerHTML = 'Cifrando respuestas... <span class="loader"></span>';
                
                showStatus('Codificando y cifrando tus respuestas...', 'info');
                
                // Encode and encrypt each answer
                const encryptedAnswers = [];
                
                for (let i = 0; i < answers.length; i++) {
                    // Create one-hot vector for this answer
                    const numOptions = questionnaireData.questions[i].options.length;
                    const vector = new Array(params.polyDegree).fill(0);
                    vector[answers[i]] = 1; // One-hot encoding
                    
                    // Encode and encrypt
                    const plaintext = encoder.encode(vector);
                    const ciphertext = encryptor.encrypt(plaintext);
                    
                    encryptedAnswers.push(ciphertext.toJSON());
                }
                
                showStatus('Enviando respuestas cifradas al servidor...', 'info');
                
                // Send encrypted answers to backend
                const response = await fetch('/api/submit-answers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        questionnaire_id: questionnaireId,
                        encrypted_answers: encryptedAnswers
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Error al enviar respuestas');
                }
                
                const result = await response.json();
                
                showStatus('‚úÖ ¬°Respuestas enviadas correctamente! Gracias por participar.', 'success');
                submitBtn.innerHTML = '‚úì Respuestas Enviadas';
                
                // Disable form
                document.querySelectorAll('input[type="radio"]').forEach(input => {
                    input.disabled = true;
                });
                
            } catch (error) {
                console.error('Error submitting questionnaire:', error);
                showStatus('Error al enviar respuestas: ' + error.message, 'error');
                
                const submitBtn = document.getElementById('submit-btn');
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Enviar Respuestas Cifradas üîê';
            }
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
        }

        function clearStatus() {
            const statusDiv = document.getElementById('status-message');
            statusDiv.style.display = 'none';
        }
    </script>
</body>
</html>
