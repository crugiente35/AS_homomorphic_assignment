<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear Cuestionario - FHE</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 40px;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .back-link:hover {
            color: #5568d3;
            transform: translateX(-5px);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .form-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .form-section h2 {
            color: #333;
            font-size: 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s ease;
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .questions-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .question-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            position: relative;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .question-number {
            font-weight: 600;
            color: #667eea;
            font-size: 16px;
        }

        .btn-remove {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-remove:hover {
            background: #c82333;
        }

        .options-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        .option-item {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .option-input {
            flex: 1;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }

        .btn-add {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-add:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-primary {
            background: #28a745;
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .btn-primary:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .help-text {
            font-size: 13px;
            color: #666;
            margin-top: 5px;
        }

        .status-message {
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            display: none;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .preview-section {
            background: #fffbea;
            border: 2px solid #ffd700;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .preview-title {
            font-weight: 600;
            color: #856404;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .note-box {
            background: #e7f3ff;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            font-size: 14px;
            color: #0c5460;
        }

        @media (max-width: 768px) {
            .container {
                padding: 30px 20px;
            }

            .option-item {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">
            ‚Üê Volver al inicio
        </a>
        
        <h1>üìù Crear Nuevo Cuestionario</h1>
        <p class="subtitle">Dise√±a un cuestionario con cifrado homom√≥rfico BFV</p>

        <div class="note-box">
            <strong>‚ÑπÔ∏è Nota importante:</strong> Cada cuestionario debe tener exactamente 8 opciones por pregunta 
            (debido a los par√°metros BFV con poly_degree=8). Puedes usar "N/A" para opciones no utilizadas.
        </div>

        <form id="questionnaire-form">
            <!-- General Settings -->
            <div class="form-section">
                <h2>‚öôÔ∏è Configuraci√≥n General</h2>
                
                <div class="form-group">
                    <label class="form-label">Fecha y hora de finalizaci√≥n</label>
                    <input type="datetime-local" class="form-input" id="deadline-datetime" required>
                    <div class="help-text">Fecha y hora exacta de finalizaci√≥n del cuestionario</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Link personalizado (opcional)</label>
                    <input type="text" class="form-input" id="custom-link" placeholder="Dejar vac√≠o para generar autom√°ticamente">
                    <div class="help-text">Si est√° vac√≠o, se generar√° un link aleatorio seguro</div>
                </div>
            </div>

            <!-- Questions -->
            <div class="form-section">
                <h2>‚ùì Preguntas</h2>
                
                <div id="questions-container" class="questions-container">
                    <!-- Las preguntas se a√±adir√°n din√°micamente -->
                </div>

                <button type="button" class="btn-add" onclick="addQuestion()">
                    ‚ûï A√±adir Pregunta
                </button>
            </div>

            <!-- Submit -->
            <button type="submit" class="btn-primary" id="submit-btn">
                üöÄ Crear Cuestionario
            </button>

            <div id="status-message" class="status-message"></div>
        </form>

        <!-- Success Modal -->
        <div id="success-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
            <div style="background: white; padding: 40px; border-radius: 12px; max-width: 600px; width: 90%; text-align: center;">
                <div style="font-size: 64px; margin-bottom: 20px;">‚úÖ</div>
                <h2 style="color: #28a745; margin-bottom: 15px;">¬°Cuestionario Creado!</h2>
                <p style="color: #666; margin-bottom: 25px;">Tu cuestionario ha sido creado exitosamente con cifrado homom√≥rfico BFV.</p>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                    <div style="font-weight: 600; color: #333; margin-bottom: 10px;">Link del cuestionario:</div>
                    <input type="text" id="generated-link" readonly style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; text-align: center; font-family: monospace;">
                </div>

                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button onclick="copyGeneratedLink()" class="btn-add">
                        üìã Copiar Link
                    </button>
                    <a id="view-questionnaire-btn" href="#" class="btn-add" style="text-decoration: none;">
                        üëÅÔ∏è Ver Cuestionario
                    </a>
                    <button onclick="location.href='create.html'" class="btn-add">
                        ‚ûï Crear Otro
                    </button>
                    <button onclick="location.href='list.html'" class="btn-add">
                        üìä Ver Lista
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let questionCount = 0;

        // Add initial question and set min datetime
        window.addEventListener('DOMContentLoaded', () => {
            addQuestion();
            
            // Set minimum datetime to current time
            const datetimeInput = document.getElementById('deadline-datetime');
            const now = new Date();
            // Add 1 hour as minimum
            now.setHours(now.getHours() + 1);
            const minDatetime = now.toISOString().slice(0, 16);
            datetimeInput.min = minDatetime;
            
            // Set default to 7 days from now
            const defaultDate = new Date();
            defaultDate.setDate(defaultDate.getDate() + 7);
            datetimeInput.value = defaultDate.toISOString().slice(0, 16);
        });

        function addQuestion() {
            questionCount++;
            const container = document.getElementById('questions-container');
            
            const questionCard = document.createElement('div');
            questionCard.className = 'question-card';
            questionCard.id = `question-${questionCount}`;
            
            questionCard.innerHTML = `
                <div class="question-header">
                    <div class="question-number">Pregunta ${questionCount}</div>
                    ${questionCount > 1 ? `<button type="button" class="btn-remove" onclick="removeQuestion(${questionCount})">Eliminar</button>` : ''}
                </div>
                
                <div class="form-group">
                    <label class="form-label">Texto de la pregunta</label>
                    <textarea class="form-textarea" id="question-text-${questionCount}" required placeholder="Escribe tu pregunta aqu√≠..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Opciones (exactamente 8 requeridas)</label>
                    <div class="options-list" id="options-${questionCount}">
                        ${[1,2,3,4,5,6,7,8].map(i => `
                            <div class="option-item">
                                <span style="color: #999; min-width: 30px;">Opc ${i}:</span>
                                <input type="text" class="option-input" placeholder="${i <= 4 ? 'Opci√≥n ' + i : 'N/A'}" value="${i <= 4 ? '' : 'N/A'}" required>
                            </div>
                        `).join('')}
                    </div>
                    <div class="help-text">Las opciones "N/A" no se mostrar√°n a los usuarios</div>
                </div>
            `;
            
            container.appendChild(questionCard);
        }

        function removeQuestion(id) {
            const card = document.getElementById(`question-${id}`);
            if (card) {
                card.remove();
                // Renumber remaining questions
                const cards = document.querySelectorAll('.question-card');
                cards.forEach((card, index) => {
                    const numberDiv = card.querySelector('.question-number');
                    if (numberDiv) {
                        numberDiv.textContent = `Pregunta ${index + 1}`;
                    }
                });
            }
        }

        document.getElementById('questionnaire-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = '‚è≥ Creando...';
            
            try {
                // Collect form data
                const deadlineDateTime = document.getElementById('deadline-datetime').value;
                if (!deadlineDateTime) {
                    throw new Error('Debes especificar una fecha y hora de finalizaci√≥n');
                }
                const customLink = document.getElementById('custom-link').value.trim() || null;
                
                // Collect questions
                const questions = [];
                const questionCards = document.querySelectorAll('.question-card');
                
                questionCards.forEach((card, index) => {
                    const id = card.id.split('-')[1];
                    const text = document.getElementById(`question-text-${id}`).value;
                    const optionInputs = card.querySelectorAll('.option-input');
                    const options = Array.from(optionInputs).map(input => input.value.trim());
                    
                    if (options.length !== 8) {
                        throw new Error(`La pregunta ${index + 1} debe tener exactamente 8 opciones`);
                    }
                    
                    questions.push({
                        text: text,
                        options: options
                    });
                });

                if (questions.length === 0) {
                    throw new Error('Debes a√±adir al menos una pregunta');
                }

                showStatus('Generando claves de cifrado BFV...', 'info');
                
                // Send to backend
                const response = await fetch('/api/create-questionnaire', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        questions: questions,
                        deadline_datetime: deadlineDateTime,
                        link: customLink
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Error al crear cuestionario');
                }

                const result = await response.json();
                
                // Show success modal
                showSuccessModal(result);
                
            } catch (error) {
                console.error('Error creating questionnaire:', error);
                showStatus('Error: ' + error.message, 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = 'üöÄ Crear Cuestionario';
            }
        });

        function showSuccessModal(result) {
            const modal = document.getElementById('success-modal');
            const linkInput = document.getElementById('generated-link');
            const viewBtn = document.getElementById('view-questionnaire-btn');
            
            const fullUrl = `${window.location.origin}/questionnaire.html?id=${result.link}`;
            linkInput.value = fullUrl;
            viewBtn.href = `questionnaire.html?id=${result.link}`;
            
            modal.style.display = 'flex';
        }

        function copyGeneratedLink() {
            const linkInput = document.getElementById('generated-link');
            linkInput.select();
            document.execCommand('copy');
            alert('‚úì Link copiado al portapapeles');
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.className = `status-message ${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            
            if (type !== 'info') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }
    </script>
</body>
</html>
